from setuptools import setup, find_packages
from setuptools.extension import Extension
from setuptools import Distribution

import os
import subprocess

import numpy

project_description = '@PROJECT_DESCRIPTION@'
long_description = '@PROJECT_LONG_DESCRIPTION@'
project_name = '@PROJECT_NAME@'
project_version = '@PROJECT_VERSION@'
license_file = 'LICENSE.txt'
maintainer_name = '@PROJECT_MAINTAINER_NAME@'
maintainer_email = '@PROJECT_MAINTAINER_EMAIL@'

local_build = True

ldflags = []
cflags = []
lib_dirs = []
include_dirs = []

try:
    from local_config import local_libdirs, local_include_dirs
    lib_dirs += local_libdirs
    include_dirs += local_include_dirs
except ImportError:
    local_env = os.getenv('SLEQP_LOCAL_BUILD')
    local_build = (local_env is not None)


def pkgconfig(name):

    def pkgconfig_get(flags):
        res = subprocess.run(['pkg-config', flags, name],
                             stdout=subprocess.PIPE,
                             check=True)

        return res.stdout.decode().strip().split()

    cflags = pkgconfig_get('--cflags-only-other')

    includes = pkgconfig_get('--cflags-only-I')

    libs = pkgconfig_get('--libs-only-l')

    libdirs = pkgconfig_get('--libs-only-L')

    return {'cflags': cflags,
            'includes': includes,
            'libs': libs,
            'libdirs': libdirs}


if not(local_build):
    pkgconfig_args = pkgconfig(project_name)

    ldflags += pkgconfig_args['libs']
    cflags += pkgconfig_args['cflags']
    lib_dirs += pkgconfig_args['libdirs']
    include_dirs += pkgconfig_args['includes']


def cythonize(*args, **kwargs):
    from Cython.Build import cythonize
    return cythonize(*args, **kwargs)


extensions = [
    Extension("sleqp.sleqp",
              ['src/sleqp.pyx'],
              include_dirs=[numpy.get_include()] + include_dirs,
              libraries=[project_name],
              extra_link_args=ldflags,
              library_dirs=lib_dirs,
              extra_compile_args=cflags
              )]

requirements = []

Distribution().fetch_build_eggs(['Cython'])

with open('requirements.txt') as f:
    requirements = f.read().splitlines()

setup(name=project_name,
      author=maintainer_name,
      author_email=maintainer_email,
      description=(project_description),
      license_file=license_file,
      long_description=long_description,
      version=project_version,
      ext_modules=cythonize(extensions),
      packages=find_packages(exclude=["tests"]),
      install_requires=requirements,
      setup_requires=['wheel'],
      classifiers=[
        'Programming Language :: Cython',
        'Intended Audience :: Science/Research',
        'Topic :: Scientific/Engineering :: Mathematics'
      ],
      test_suite='tests')
